# Prompt for Codex: “Trail Whisper” – React App with Supabase, Google Login, FIT Upload & 400 m Geofencing

**Goal:** Build a production-ready React/TypeScript app “Trail Whisper” that determines the current location, checks whether the user has already been active within **400 m** of that spot (including visit count, timestamps, total distance, and sport type), imports FIT files, and stores data **scoped per user** in **Supabase**. Authentication via **Google** (Supabase Auth). Fully responsive for **mobile and desktop**.

**Repo to base on / integrate with:** [https://github.com/smeir/trail-whisper](https://github.com/smeir/trail-whisper)

## Tech stack & project setup

* React + TypeScript + Vite.
* UI: Tailwind CSS + shadcn/ui (lucide-react icons). Clean, responsive, mobile-first.
* Data fetching/state: TanStack Query (React Query).
* Supabase JS client (Auth + DB + Storage/Edge Functions).
* Map: **MapLibre GL** or **Leaflet** (OpenStreetMap tiles).
* FIT parsing: npm **fit-file-parser** (or equivalent; client-side).
* Geodata: **PostGIS** in Supabase (Geography). Distance checks via `ST_DWithin`.
* Env: `.env/.env.local` with `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`.

## Routes & navigation

* **/login**: “Sign in with Google” (Supabase OAuth). Redirect to `/app`.
* **/app** (Dashboard):

    * Determine geolocation (Permissions flow).
    * Card “Been here before?” → 400 m check results:

        * If **yes**: number of visits, recent visits (date/time), sum of `total_distance_m`, most common sport at this spot.
        * If **no**: message “Not active here yet.”
    * Mini map with current position and nearby own activities (< 2 km).
* **/upload**: Drag & drop or file picker for FIT files; parse, preview (start/end, distance, sport), then persist.
* **/history**: User’s activities list with filters (sport, date range, proximity); card thumbnails with mini map.
* **/activity/:id**: Detail page (map with track, stats).
* **/account**: Profile / logout.

## UI/UX

* Mobile & desktop responsiveness, large touch targets.
* Toasts for success/errors; clear loading & empty states (skeletons).
* Client-side validation (upload).

## Database model (Supabase/Postgres + PostGIS)

Enable **PostGIS** in Supabase. Create tables & indexes:

```sql
-- Extensions
create extension if not exists postgis;

-- Supabase manages auth.users

create table public.activities (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  sport text not null check (sport in ('running','walking','hiking','cycling','swimming','other')),
  started_at timestamptz not null,
  ended_at timestamptz not null,
  total_distance_m integer not null check (total_distance_m >= 0),
  track_geom geography(LineString, 4326) not null,
  center_point geography(Point, 4326) not null,
  created_at timestamptz not null default now()
);

create index activities_center_point_gix on public.activities using gist (center_point);
create index activities_user_started_idx on public.activities (user_id, started_at desc);

alter table public.activities enable row level security;

create policy "activities_select_own"
  on public.activities for select
  using (auth.uid() = user_id);

create policy "activities_insert_own"
  on public.activities for insert
  with check (auth.uid() = user_id);

create policy "activities_update_own"
  on public.activities for update
  using (auth.uid() = user_id)
  with check (auth.uid() = user_id);

create policy "activities_delete_own"
  on public.activities for delete
  using (auth.uid() = user_id);
```

**RPC for the 400 m proximity check** (per-user, PostGIS):

```sql
create or replace function public.find_visits_near(
  lat double precision,
  lon double precision,
  radius_m integer default 400
)
returns table(
  activity_id uuid,
  started_at timestamptz,
  ended_at timestamptz,
  total_distance_m integer,
  sport text,
  distance_m double precision
)
language sql
security definer
as $$
  select
    a.id,
    a.started_at,
    a.ended_at,
    a.total_distance_m,
    a.sport,
    ST_Distance(a.center_point, ST_SetSRID(ST_MakePoint(lon, lat), 4326)::geography) as distance_m
  from public.activities a
  where a.user_id = auth.uid()
    and ST_DWithin(
      a.center_point,
      ST_SetSRID(ST_MakePoint(lon, lat), 4326)::geography,
      coalesce(radius_m, 400)
    )
  order by a.started_at desc;
$$;
```

> Note: `security definer` + RLS—ensure the function runs under the owner role and still respects RLS via `where a.user_id = auth.uid()`.

## FIT import (client)

* Use `fit-file-parser` to extract:

    * Timestamps (start/end), distance (meters), sport (map from FIT `sport`).
    * Track points (`lat`, `lon`) → serialize to LINESTRING (WGS84).
    * `center_point` = centroid (`ST_Centroid(track_geom)`) or mean lat/lon.
* After parsing, `insert` into `public.activities`.
* For large files, parse in a Web Worker.
* (Optional) Supabase Edge Function (Deno) for server-side parsing if needed.

## Auth & data visibility

* Supabase Auth with **Google** provider.
* Registration/sign-in enabled; sessions persisted.
* **All queries are strictly user-scoped** (auth.uid()).
* No cross-user visibility.

## React code structure

```
src/
  main.tsx
  App.tsx
  lib/supabase.ts
  routes/
    Login.tsx
    Dashboard.tsx
    Upload.tsx
    History.tsx
    ActivityDetail.tsx
    Account.tsx
  components/
    MapView.tsx
    GeoStatusCard.tsx
    FitDropzone.tsx
    ActivityCard.tsx
    StatsBadges.tsx
  hooks/
    useGeolocation.ts
    useVisitsNear.ts
    useActivities.ts
  styles/
    index.css
```

## Key implementation details

### Supabase client

```ts
// lib/supabase.ts
import { createClient } from '@supabase/supabase-js';

export const supabase = createClient(
  import.meta.env.VITE_SUPABASE_URL!,
  import.meta.env.VITE_SUPABASE_ANON_KEY!,
  { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
);
```

### Login

* “Sign in with Google” → `supabase.auth.signInWithOAuth({ provider: 'google' })`.
* On auth state change, redirect to `/app`.

### Geolocation (Dashboard)

* `useGeolocation`:

    * `navigator.geolocation.getCurrentPosition` (optionally `watchPosition`).
    * Graceful permission handling and fallbacks.
* `useVisitsNear` calls RPC `(lat, lon, 400)` and aggregates:

    * `count` (hits),
    * `total_distance_sum`,
    * `sportsBreakdown`,
    * `lastVisits` (latest 3–5 results).
* `GeoStatusCard` renders the yes/no status, KPIs, and links to History/Details.
* Map shows current location + simplified polylines of nearby own activities.

### FIT upload

* `FitDropzone`:

    * Multi-file upload.
    * Parse with `fit-file-parser` → normalized structure.
    * Build WKT LINESTRING: `LINESTRING(lon lat, lon lat, ...)`.
    * Example insert:

      ```ts
      const { error } = await supabase.from('activities').insert({
        user_id: user.id,
        sport,
        started_at,
        ended_at,
        total_distance_m,
        track_geom: `SRID=4326;${lineStringWkt}`,
        center_point: `SRID=4326;POINT(${centerLon} ${centerLat})`,
      });
      ```
    * On success: toast + redirect to `/history`.

### History & detail

* History: pagination; filters (sport, date range, optional proximity to current location).
* ActivityDetail: fetch by `id`, render track on map, metrics, export (GeoJSON download).

### Security & policies

* RLS **enabled** (see SQL).
* Client must never reference another user’s `user_id`; rely on `auth.uid()`.
* All Supabase queries/RPC respect RLS.

### Tests & acceptance criteria

* Without login → redirect to `/login`.
* With login:

    * Geolocation works and 400 m check returns results (mock sample coordinates).
    * Upload at least one FIT → activity appears in History; Detail page loads with map.
    * Dashboard reports “Been here: yes” after upload if `center_point` is within 400 m.
    * RLS verified: second test user cannot see the first user’s activities.
* Performance: LCP < 2.5 s on mobile for the Dashboard (without heavy map layers).
* Scripts: `npm run dev`, `npm run build`, `npm run preview`.
* Lint/format: ESLint + Prettier.

### Styling & components

* Use shadcn/ui (Cards, Button, Input, Tabs, Dialog, Toast).
* Icons via lucide-react (MapPin, Activity, Upload).
* Consistent spacing, rounded corners (`rounded-2xl`), soft shadows.

### Environment & README

* README should cover:

    1. Create Supabase project; enable PostGIS; run SQL above.
    2. Enable Google auth in Supabase; set redirect URIs.
    3. Create `.env.local` with URL + ANON KEY.
    4. `npm install && npm run dev`.

## Bonus (optional)

* PWA (Workbox) with offline fallback for History.
* Edge Function for server-side FIT parsing.
* Activity clustering on the map.
* Heatmap layer of user tracks.

---

**Requirements to Codex:**

* **No stubs** for core features (Auth, FIT parsing, RPC, RLS).
* Provide **runnable code** with example components, hooks, and SQL migrations.
* Handle errors with toasts; show loading/empty states.

**Acceptance:** After `npm install && npm run dev`, I can sign in with Google, upload a FIT file, see the 400 m proximity check on the Dashboard for my current location (using my uploaded activities), and browse `/history` & details—**only my data** is visible.
